<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„çå‹µè¨ˆç•«è¡¨ (é›²ç«¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        function notReadyAlert() { alert("ç³»çµ±æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«ï¼Œè«‹ç¨å€™ç´„ 3 ç§’å†è©¦..."); }
        window.showLoginModal = notReadyAlert;
        window.closeLoginModal = function() { document.getElementById('login-modal').classList.add('hidden'); };
        window.handleLoginAction = notReadyAlert;
        window.handleRegisterAction = notReadyAlert;
        window.handleLogout = function() {};
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // å…¨åŸŸè®Šæ•¸åˆå§‹åŒ–
        window.db = null;
        window.auth = null;
        window.appId = null;
        window.firestoreReady = false;
        window.userUid = null;
        
        // ç°¡æ˜“çš„ Cloud Manager
        window.CloudManager = {
            docId: null,
            isLoggedIn: false,
            username: null,
            
            init: async function() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyB2HeIlJGFx9JIcuGvv9QNDfJJDJR5BaIU",
                        authDomain: "a815355666-cf56b.firebaseapp.com",
                        projectId: "a815355666-cf56b",
                        storageBucket: "a815355666-cf56b.firebasestorage.app",
                        messagingSenderId: "16313919572",
                        appId: "1:16313919572:web:2ffceaea9952b1d309e5c1",
                        measurementId: "G-51TP8K4BQY"
                    };
                    
                    window.appId = firebaseConfig.projectId; 
                    
                    // åˆå§‹åŒ– Firebase
                    const app = initializeApp(firebaseConfig);
                    const analytics = getAnalytics(app);

                    window.auth = getAuth(app);
                    window.db = getFirestore(app);
                    
                    // ç›£è½ Auth ç‹€æ…‹
                    onAuthStateChanged(window.auth, async (user) => {
                        if (user) {
                            window.userUid = user.uid;
                            window.firestoreReady = true;
                            console.log("Firebase Auth Ready:", user.uid);
                            this.bindButtons(); // ç¶å®šæŒ‰éˆ•åŠŸèƒ½
                            
                            // è‡ªå‹•ç™»å…¥æª¢æŸ¥
                            const savedUser = localStorage.getItem('cloud_user');
                            const savedPass = localStorage.getItem('cloud_pass');
                            if(savedUser && savedPass && !this.isLoggedIn) {
                                this.performLogin(savedUser, savedPass, true);
                            }
                        }
                    });

                    // åŒ¿åç™»å…¥
                    if (!window.auth.currentUser) {
                        await signInAnonymously(window.auth);
                    }

                } catch (e) {
                    console.error("Init Error:", e);
                    window.showLoginModal = function() { alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡æ–°æ•´ç†ç¶²é ã€‚\n" + e.message); };
                }
            },
            
            bindButtons: function() {
                window.showLoginModal = () => {
                    document.getElementById('login-modal').classList.remove('hidden');
                    this.resetBtnStates();
                };

                window.closeLoginModal = () => {
                    document.getElementById('login-modal').classList.add('hidden');
                };

                window.handleLoginAction = () => {
                    const {u, p} = this.getInputs();
                    if(!u || !p) return;
                    this.performLogin(u, p, false);
                };

                window.handleRegisterAction = () => {
                    const {u, p} = this.getInputs();
                    if(!u || !p) return;
                    this.performRegister(u, p);
                };

                window.handleLogout = () => {
                    if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) this.logout();
                };
            },

            getInputs: function() {
                const u = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                if(!u || !p) { alert('è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼'); return {u:null, p:null}; }
                return {u, p};
            },

            resetBtnStates: function() {
                const btnLogin = document.getElementById('btn-login-action');
                const btnReg = document.getElementById('btn-register-action');
                if(btnLogin) { btnLogin.innerHTML = 'ç™»å…¥'; btnLogin.disabled = false; }
                if(btnReg) { btnReg.innerHTML = 'è¨»å†Šæ–°å¸³è™Ÿ'; btnReg.disabled = false; }
            },

            setLoading: function(isLogin) {
                const btn = isLogin ? document.getElementById('btn-login-action') : document.getElementById('btn-register-action');
                if(btn) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';
                    btn.disabled = true;
                }
            },

            generateId: function(user, pass) {
                return `user_${user}_${pass}`.replace(/[^a-zA-Z0-9_]/g, '');
            },

            performLogin: async function(user, pass, isAuto = false) {
                if (!window.firestoreReady) { if(!isAuto) alert("é€£ç·šä¸­..."); return; }
                if(!isAuto) this.setLoading(true);

                const docId = this.generateId(user, pass);
                
                try {
                    const userDocRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'reward_users', docId);
                    const docSnap = await getDoc(userDocRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        window.importCloudData(data);
                        this.loginSuccess(user, pass, docId);
                        if(!isAuto) {
                            alert("ç™»å…¥æˆåŠŸï¼");
                            window.closeLoginModal();
                        }
                    } else {
                        if(!isAuto) {
                            alert("æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ã€‚\nå¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè«‹é»æ“Šã€Œè¨»å†Šæ–°å¸³è™Ÿã€ã€‚");
                            this.resetBtnStates();
                        }
                    }
                } catch (error) {
                    console.error("Login Error:", error);
                    if(!isAuto) {
                        alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
                        this.resetBtnStates();
                    }
                }
            },

            performRegister: async function(user, pass) {
                if (!window.firestoreReady) { alert("é€£ç·šä¸­..."); return; }
                this.setLoading(false);

                const docId = this.generateId(user, pass);
                
                try {
                    const userDocRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'reward_users', docId);
                    const docSnap = await getDoc(userDocRef);

                    if (docSnap.exists()) {
                        alert("é€™å€‹å¸³è™Ÿå¯†ç¢¼çµ„åˆå·²ç¶“è¢«è¨»å†Šéäº†ï¼\nè«‹ç›´æ¥é»æ“Šã€Œç™»å…¥ã€æŒ‰éˆ•ã€‚");
                        this.resetBtnStates();
                    } else {
                        await this.saveDataToCloud(docId, user, true); 
                        this.loginSuccess(user, pass, docId);
                        alert("è¨»å†ŠæˆåŠŸï¼å·²å°‡ç›®å‰çš„è¨ˆç•«è¡¨ä¸Šå‚³ã€‚");
                        window.closeLoginModal();
                    }
                } catch (error) {
                    console.error("Register Error:", error);
                    alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
                    this.resetBtnStates();
                }
            },

            loginSuccess: function(user, pass, docId) {
                this.isLoggedIn = true;
                this.docId = docId;
                this.username = user;
                localStorage.setItem('cloud_user', user);
                localStorage.setItem('cloud_pass', pass);

                document.getElementById('auth-section-login-btn').classList.add('hidden');
                document.getElementById('user-status').classList.remove('hidden');
                document.getElementById('display-username').textContent = user;
                document.getElementById('cloud-indicator').classList.remove('hidden');
                this.saveDataToCloud();
            },

            logout: function() {
                this.isLoggedIn = false;
                this.docId = null;
                this.username = null;
                localStorage.removeItem('cloud_user');
                localStorage.removeItem('cloud_pass');
                
                document.getElementById('user-status').classList.add('hidden');
                document.getElementById('auth-section-login-btn').classList.remove('hidden');
                document.getElementById('cloud-indicator').classList.add('hidden');
                alert("å·²ç™»å‡º");
            },

            saveDataToCloud: async function(targetDocId, targetUsername, isNew = false) {
                const docIdToUse = targetDocId || this.docId;
                const userToUse = targetUsername || this.username;
                
                if (!docIdToUse || !window.firestoreReady) return;

                const dataToSave = {
                    tasks: window.tasks,
                    shopItems: window.shopItems,
                    redemptions: window.redemptions,
                    lastUpdated: new Date().toISOString(),
                    owner: userToUse
                };

                const userDocRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'reward_users', docIdToUse);
                await setDoc(userDocRef, dataToSave);
                
                if(!isNew) {
                    const indicator = document.getElementById('save-indicator');
                    if(indicator) {
                        indicator.classList.remove('opacity-0');
                        setTimeout(() => indicator.classList.add('opacity-0'), 2000);
                    }
                }
            },
            
            save: function() {
                if(this.isLoggedIn) this.saveDataToCloud();
            }
        };

        window.CloudManager.init();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0fdfa; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .task-checkbox:checked + div { text-decoration: line-through; color: #9ca3af; }
        
        /* Calendar Styles */
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 4px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; position: relative; }
        .calendar-day:hover { background-color: #e0e7ff; }
        .calendar-day.active { background-color: #4f46e5; color: white; }
        .calendar-day.today { border: 2px solid #4f46e5; font-weight: bold; }
        .calendar-day.has-task::after { content: ''; width: 4px; height: 4px; background-color: #ec4899; border-radius: 50%; margin-top: 2px; }
        .calendar-day.active.has-task::after { background-color: white; }
        .calendar-day.is-holiday::before { content: ''; position: absolute; top: 4px; right: 4px; width: 4px; height: 4px; background-color: #ef4444; border-radius: 50%; }
        .calendar-day.active.is-holiday::before { background-color: #fca5a5; }

        .tab-btn { transition: all 0.3s; border-bottom: 3px solid transparent; opacity: 0.6; }
        .tab-btn.active { border-bottom-color: white; opacity: 1; font-weight: bold; }
        .view-container { transition: transform 0.3s ease-in-out, opacity 0.3s; }
        
        /* Animation for Modal */
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-scaleIn { animation: scaleIn 0.2s ease-out; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-[100dvh] text-gray-800 p-2 md:p-4 box-border">

    <div class="w-full max-w-md bg-white rounded-2xl md:rounded-3xl shadow-xl overflow-hidden flex flex-col h-[calc(100dvh-1rem)] md:h-auto md:min-h-[750px] relative">
        
        <div class="bg-indigo-600 p-4 md:p-6 pb-2 text-white flex flex-col shadow-md z-10 shrink-0">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full flex items-center gap-1 hidden" id="cloud-indicator">
                        <i class="fas fa-cloud text-sky-300"></i> é›²ç«¯åŒæ­¥
                    </span>
                    <span id="save-indicator" class="text-[10px] text-green-300 transition-opacity duration-500 opacity-0 font-bold">
                        <i class="fas fa-check"></i> å·²å„²å­˜
                    </span>
                </div>
                
                <div id="auth-section">
                    <div id="auth-section-login-btn">
                        <button onclick="showLoginModal()" class="text-xs bg-indigo-700 hover:bg-indigo-800 px-3 py-1 rounded-full transition border border-indigo-500 shadow-sm">
                            <i class="fas fa-user-circle"></i> ç™»å…¥ / è¨»å†Š
                        </button>
                    </div>
                    
                    <div id="user-status" class="hidden flex items-center gap-2">
                        <span class="text-xs opacity-90">Hi, <span id="display-username" class="font-bold"></span></span>
                        <button onclick="handleLogout()" class="text-[10px] bg-red-500/80 hover:bg-red-600 px-2 py-1 rounded transition">
                            ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-start mb-3">
                <div>
                   <h1 id="header-clock" class="text-xs md:text-sm opacity-80 font-medium font-mono">è¼‰å…¥ä¸­...</h1>
                    <div class="flex items-baseline gap-2">
                        <div id="header-date" class="text-xl md:text-2xl font-bold tracking-wide">è¼‰å…¥ä¸­...</div>
                        <div id="header-holiday" class="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full hidden"></div>
                    </div>
                </div>
                <div class="bg-indigo-500/50 rounded-lg p-2 px-3 text-center backdrop-blur-sm min-w-[70px]">
                    <div class="text-[10px] md:text-xs opacity-80">æŒæœ‰é‡‘å¹£</div>
                    <div class="text-lg md:text-xl font-bold text-yellow-300">
                        $<span id="current-balance">0</span>
                    </div>
                </div>
            </div>

            <div class="flex gap-2 mt-1">
                <button onclick="clickDailyTab()" id="tab-daily" class="tab-btn active pb-2 flex-1 text-center text-sm">ä»Šæ—¥è¨ˆç•«</button>
                <button onclick="switchTab('monthly')" id="tab-monthly" class="tab-btn pb-2 flex-1 text-center text-sm">æˆ‘çš„æ—¥æ›†</button>
                <button onclick="switchTab('shop')" id="tab-shop" class="tab-btn pb-2 flex-1 text-center text-sm">å…Œæ›å•†åº—</button>
            </div>
        </div>

        <div class="flex-1 overflow-hidden relative bg-gray-50">
            <div id="view-list" class="view-container absolute inset-0 flex flex-col bg-gray-50 z-10">
                <div id="holiday-alert-banner" class="hidden bg-red-100 text-red-600 px-4 py-2 text-sm font-bold text-center flex items-center justify-center gap-2 shrink-0 border-b border-red-200">
                    <i class="fas fa-gift"></i> <span id="holiday-name"></span>
                </div>
                <div id="selected-date-banner" class="hidden bg-yellow-100 text-yellow-800 text-center py-1 text-sm font-medium flex justify-between px-4 items-center shrink-0">
                    <span class="truncate text-xs"><i class="fas fa-calendar-alt mr-1"></i> <span id="editing-date-display"></span></span>
                    <button onclick="backToToday()" class="text-indigo-600 hover:text-indigo-800 underline text-xs whitespace-nowrap ml-2">å›åˆ°ä»Šæ—¥</button>
                </div>
                <div class="p-3 md:p-4 bg-white border-b border-gray-100 shadow-sm z-10 shrink-0">
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="task-input" class="flex-[2] bg-gray-50 border border-gray-200 text-gray-900 rounded-lg md:rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none p-2 md:p-3 text-sm md:text-base" placeholder="è¨ˆç•«è¦åšä»€éº¼ï¼Ÿ">
                        <input type="number" id="reward-input" class="w-20 md:flex-[1] bg-gray-50 border border-gray-200 text-gray-900 rounded-lg md:rounded-xl focus:ring-2 focus:ring-yellow-400 outline-none p-2 md:p-3 text-center text-sm md:text-base" placeholder="$">
                    </div>
                    <button onclick="addTask()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg md:rounded-xl py-2 md:py-3 shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2 text-sm md:text-base">
                        <i class="fas fa-plus-circle"></i> åŠ å…¥è¨ˆç•«
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-3 md:p-4 space-y-3 no-scrollbar" id="task-list"></div>
                <div id="empty-state" class="hidden absolute inset-0 top-32 flex-col items-center justify-center text-gray-400 pointer-events-none">
                    <i class="fas fa-mug-hot text-5xl mb-3 text-indigo-100"></i>
                    <p class="text-sm">æœ¬æ—¥å°šç„¡è¨ˆç•«</p>
                </div>
            </div>

            <div id="view-calendar" class="view-container absolute inset-0 flex flex-col bg-white transform translate-x-full overflow-y-auto z-20">
                <div class="flex justify-between items-center p-4 shrink-0">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-month-year" class="text-lg font-bold text-gray-800"></h2>
                    <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-xs text-gray-400 font-medium mb-2 px-2 shrink-0">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 px-2 pb-4 shrink-0"></div>
                <div class="flex-1 bg-gray-50 border-t border-gray-100 p-4 overflow-y-auto">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-gray-500"><span id="preview-date-label">é¸æ“‡æ—¥æœŸ</span></h3>
                        <button onclick="editSelectedDate()" id="btn-edit-date" class="hidden text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 whitespace-nowrap">å»ç·¨è¼¯ <i class="fas fa-arrow-right ml-1"></i></button>
                    </div>
                    <div id="calendar-holiday-info" class="hidden mb-2 text-xs text-red-500 font-bold bg-red-50 p-2 rounded-lg"><i class="fas fa-star mr-1"></i> <span id="calendar-holiday-name"></span></div>
                    <ul id="calendar-preview-list" class="space-y-2 text-sm text-gray-600"></ul>
                </div>
            </div>

            <div id="view-shop" class="view-container absolute inset-0 flex flex-col bg-gray-50 transform translate-x-full z-20 overflow-hidden">
                <div class="p-3 md:p-4 bg-white border-b border-gray-100 shadow-sm z-10 shrink-0">
                    <h2 id="shop-stats-header" class="text-sm font-bold text-gray-500 mb-2 flex justify-between items-center">
                        <span>å·²é”æˆè¨ˆç•«æ•¸é‡</span>
                        <span id="completed-count-display" class="text-indigo-600 text-lg">0</span>
                    </h2>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="shop-item-input" class="flex-[2] bg-gray-50 border border-gray-200 text-gray-900 rounded-lg md:rounded-xl focus:ring-2 focus:ring-purple-500 outline-none p-2 md:p-3 text-sm md:text-base" placeholder="ä¾†å»è²·æ·˜å¯¶">
                        <input type="number" id="shop-cost-input" class="w-20 md:flex-[1] bg-gray-50 border border-gray-200 text-gray-900 rounded-lg md:rounded-xl focus:ring-2 focus:ring-purple-500 outline-none p-2 md:p-3 text-center text-sm md:text-base" placeholder="$">
                    </div>
                    <button onclick="addShopItem()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg md:rounded-xl py-2 shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2 text-sm md:text-base"><i class="fas fa-plus"></i> æ–°å¢çå‹µ</button>
                </div>
                <div class="flex-1 overflow-y-auto p-3 md:p-4 space-y-3 no-scrollbar">
                    <div id="shop-list" class="grid grid-cols-1 gap-3"></div>
                    <div class="mt-6 mb-4">
                        <h3 class="text-sm font-bold text-gray-400 mb-2 px-1">å…Œæ›ç´€éŒ„ (æœ€è¿‘ 5 ç­†)</h3>
                        <ul id="redemption-history" class="space-y-2 text-sm text-gray-500 px-1"></ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="login-modal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-scaleIn">
            <div class="bg-indigo-600 p-4 text-white text-center relative">
                <h3 class="text-lg font-bold">é›²ç«¯åŒæ­¥</h3>
                <p class="text-xs opacity-80 mt-1">è·¨è£ç½®å­˜å–æ‚¨çš„è¨ˆç•«è¡¨</p>
                <button onclick="closeLoginModal()" class="absolute top-4 right-4 text-white/70 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">å¸³è™Ÿ</label>
                    <input type="text" id="login-user" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" placeholder="è¼¸å…¥æ‚¨çš„å¸³è™Ÿ">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">å¯†ç¢¼</label>
                    <input type="password" id="login-pass" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition" placeholder="è¼¸å…¥æ‚¨çš„å¯†ç¢¼">
                </div>
                
                <div class="flex flex-col gap-3 mt-4">
                    <button onclick="handleLoginAction()" id="btn-login-action" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">
                        ç™»å…¥
                    </button>
                    <div class="relative flex py-1 items-center">
                        <div class="flex-grow border-t border-gray-200"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">æˆ–</span>
                        <div class="flex-grow border-t border-gray-200"></div>
                    </div>
                    <button onclick="handleRegisterAction()" id="btn-register-action" class="w-full bg-white border-2 border-indigo-100 hover:bg-indigo-50 text-indigo-600 font-bold py-2 rounded-xl active:scale-95 transition">
                        è¨»å†Šæ–°å¸³è™Ÿ
                    </button>
                </div>
                <div class="text-[10px] text-center text-gray-400">
                    è¨»å†Šå¾Œï¼Œç›®å‰çš„æœ¬åœ°è³‡æ–™å°‡æœƒä¸Šå‚³è‡³é›²ç«¯ã€‚
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-scaleIn">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold"><i class="fas fa-edit"></i> ä¿®æ”¹è¨ˆç•«</h3>
                <button onclick="closeEditModal()" class="text-white/70 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-task-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">è¨ˆç•«å…§å®¹</label>
                    <input type="text" id="edit-task-text" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">çå‹µé‡‘é¡ ($)</label>
                    <input type="number" id="edit-task-reward" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                </div>
                
                <div class="flex gap-3 mt-4">
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 rounded-xl transition">
                        å–æ¶ˆ
                    </button>
                    <button onclick="saveEditTask()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">
                        å„²å­˜ä¿®æ”¹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šèˆ‡ç‹€æ…‹ ---
        window.tasks = JSON.parse(localStorage.getItem('myDailyPlans_v2')) || [];
        window.shopItems = JSON.parse(localStorage.getItem('myShopItems')) || [{ id: 1, text: 'è²·ä¸€ä»¶è¡£æœ', cost: 50 }];
        window.redemptions = JSON.parse(localStorage.getItem('myRedemptions')) || [];

        // è³‡æ–™åŒ¯å…¥
        window.importCloudData = function(data) {
            if(data.tasks) window.tasks = data.tasks;
            if(data.shopItems) window.shopItems = data.shopItems;
            if(data.redemptions) window.redemptions = data.redemptions;
            saveData(false);
            updateHeader();
            if (currentView === 'daily') renderTaskList();
            if (currentView === 'monthly') renderCalendar();
            if (currentView === 'shop') renderShop();
        }

        // åˆå§‹åŒ–èˆŠè³‡æ–™
        if (!Array.isArray(window.tasks) || (window.tasks.length > 0 && !window.tasks[0].date)) {
            const oldTasks = JSON.parse(localStorage.getItem('myDailyPlans')) || [];
            if(oldTasks.length > 0) {
                const today = getTaipeiDateString();
                window.tasks = oldTasks.map(t => ({
                    id: Date.now() + Math.random(),
                    text: t.text, reward: 0, completed: t.completed, date: today 
                }));
                localStorage.setItem('myDailyPlans_v2', JSON.stringify(window.tasks));
            }
        }

        let currentView = 'daily'; 
        let selectedDate = getTaipeiDateString(); 
        let calendarYear = new Date().getFullYear();
        let calendarMonth = new Date().getMonth(); 

        const holidays = {
            '01-01': 'å…ƒæ—¦', '02-28': 'å’Œå¹³ç´€å¿µæ—¥', '04-04': 'å…’ç«¥ç¯€', '04-05': 'æ¸…æ˜ç¯€', '05-01': 'å‹å‹•ç¯€',
            '08-08': 'çˆ¶è¦ªç¯€', '10-10': 'åœ‹æ…¶æ—¥', '10-31': 'è¬è–ç¯€', '12-25': 'è–èª•ç¯€', '12-31': 'è·¨å¹´',
            '2025-01-25': 'æ˜¥ç¯€é€£å‡', '2025-01-26': 'æ˜¥ç¯€é€£å‡', '2025-01-27': 'å°å¹´å¤œ', '2025-01-28': 'é™¤å¤•', '2025-01-29': 'æ˜¥ç¯€ (åˆä¸€)', '2025-01-30': 'åˆäºŒ', '2025-01-31': 'åˆä¸‰', '2025-02-01': 'åˆå››', '2025-02-02': 'åˆäº”',
            '2025-02-28': 'å’Œå¹³ç´€å¿µæ—¥', '2025-03-01': '228é€£å‡', '2025-03-02': '228é€£å‡', '2025-04-03': 'å…’ç«¥ç¯€(è£œå‡)', '2025-04-04': 'æ¸…æ˜ç¯€', '2025-04-05': 'æ¸…æ˜é€£å‡', '2025-04-06': 'æ¸…æ˜é€£å‡',
            '2025-05-11': 'æ¯è¦ªç¯€', '2025-05-30': 'ç«¯åˆç¯€(è£œå‡)', '2025-05-31': 'ç«¯åˆç¯€', '2025-06-01': 'ç«¯åˆé€£å‡', '2025-10-04': 'ä¸­ç§‹é€£å‡', '2025-10-05': 'ä¸­ç§‹é€£å‡', '2025-10-06': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥', '2025-10-11': 'åœ‹æ…¶é€£å‡', '2025-10-12': 'åœ‹æ…¶é€£å‡',
            '2026-01-01': 'å…ƒæ—¦', '2026-02-14': 'æ˜¥ç¯€é€£å‡', '2026-02-15': 'æ˜¥ç¯€é€£å‡', '2026-02-16': 'é™¤å¤•', '2026-02-17': 'æ˜¥ç¯€ (åˆä¸€)', '2026-02-18': 'åˆäºŒ', '2026-02-19': 'åˆä¸‰', '2026-02-20': 'æ˜¥ç¯€é€£å‡', '2026-02-21': 'æ˜¥ç¯€é€£å‡', '2026-02-22': 'æ˜¥ç¯€é€£å‡',
            '2026-02-27': '228é€£å‡', '2026-02-28': 'å’Œå¹³ç´€å¿µæ—¥', '2026-03-01': '228é€£å‡', '2026-04-03': 'å…’ç«¥ç¯€', '2026-04-04': 'æ¸…æ˜ç¯€', '2026-04-05': 'æ¸…æ˜é€£å‡', '2026-04-06': 'æ¸…æ˜é€£å‡',
            '2026-05-01': 'å‹å‹•ç¯€', '2026-05-02': 'å‹å‹•ç¯€é€£å‡', '2026-05-03': 'å‹å‹•ç¯€é€£å‡', '2026-06-19': 'ç«¯åˆé€£å‡', '2026-06-20': 'ç«¯åˆç¯€', '2026-06-21': 'ç«¯åˆé€£å‡', '2026-09-25': 'ä¸­ç§‹ç¯€', '2026-09-26': 'ä¸­ç§‹é€£å‡', '2026-09-27': 'ä¸­ç§‹é€£å‡', '2026-09-28': 'ä¸­ç§‹é€£å‡',
            '2026-10-09': 'åœ‹æ…¶é€£å‡', '2026-10-10': 'åœ‹æ…¶æ—¥', '2026-10-11': 'åœ‹æ…¶é€£å‡', '2026-10-24': 'å…‰å¾©ç¯€é€£å‡', '2026-10-25': 'è‡ºç£å…‰å¾©ç¯€', '2026-10-26': 'å…‰å¾©ç¯€è£œå‡', '2026-12-25': 'è¡Œæ†²ç´€å¿µæ—¥', '2026-12-26': 'è¡Œæ†²ç´€å¿µæ—¥é€£å‡', '2026-12-27': 'è¡Œæ†²ç´€å¿µæ—¥é€£å‡'
        };

        function getHolidayName(dateStr) {
            if (holidays[dateStr]) return holidays[dateStr];
            const [y, m, d] = dateStr.split('-');
            const shortDate = `${m}-${d}`;
            if (holidays[shortDate]) return holidays[shortDate];
            return null;
        }

        // æ ¸å¿ƒå·¥å…·
        function getTaipeiDateObject() {
            const now = new Date();
            return new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
        }

        function getTaipeiDateString(dateObj = null) {
            const d = dateObj || getTaipeiDateObject();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateDisplay(dateStr) {
            const [y, m, d] = dateStr.split('-');
            return `${m}æœˆ${d}æ—¥`;
        }

        function escapeHtml(text) {
            return text.replace(/[&<>"']/g, function(m) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]; });
        }

        // é‡‘å¹£èˆ‡ Header
        function calculateBalance() {
            const totalEarned = window.tasks.filter(t => t.completed).reduce((sum, t) => sum + (parseInt(t.reward) || 0), 0);
            const totalSpent = window.redemptions.reduce((sum, r) => sum + (parseInt(r.cost) || 0), 0);
            return totalEarned - totalSpent;
        }

        function updateHeader() {
            const taipeiNow = getTaipeiDateObject();
            const todayStr = getTaipeiDateString(taipeiNow);
            document.getElementById('header-date').textContent = new Intl.DateTimeFormat('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' }).format(taipeiNow);
            
            const todayHoliday = getHolidayName(todayStr);
            const headerHolidayEl = document.getElementById('header-holiday');
            if (todayHoliday) {
                headerHolidayEl.textContent = todayHoliday;
                headerHolidayEl.classList.remove('hidden');
            } else {
                headerHolidayEl.classList.add('hidden');
            }

            const balance = calculateBalance();
            const balanceEl = document.getElementById('current-balance');
            balanceEl.textContent = balance;
            balanceEl.parentElement.classList.remove('text-yellow-300');
            void balanceEl.offsetWidth; 
            balanceEl.parentElement.classList.add('text-yellow-300');
        }

        // å„²å­˜æ ¸å¿ƒ
        function saveData(syncToCloud = true) {
            localStorage.setItem('myDailyPlans_v2', JSON.stringify(window.tasks));
            localStorage.setItem('myShopItems', JSON.stringify(window.shopItems));
            localStorage.setItem('myRedemptions', JSON.stringify(window.redemptions));
            
            updateHeader();
            if (currentView === 'daily') renderTaskList();
            if (currentView === 'monthly') renderCalendar();
            if (currentView === 'shop') renderShop();

            if (syncToCloud && window.CloudManager && window.CloudManager.isLoggedIn) {
                window.CloudManager.save();
            }
        }

        // List View
        function renderTaskList() {
            const listEl = document.getElementById('task-list');
            const emptyState = document.getElementById('empty-state');
            const todayStr = getTaipeiDateString();
            
            const banner = document.getElementById('selected-date-banner');
            const editDateDisplay = document.getElementById('editing-date-display');
            
            if (selectedDate !== todayStr) {
                banner.classList.remove('hidden');
                editDateDisplay.textContent = formatDateDisplay(selectedDate);
            } else {
                banner.classList.add('hidden');
            }

            const holidayName = getHolidayName(selectedDate);
            const holidayBanner = document.getElementById('holiday-alert-banner');
            const holidayNameSpan = document.getElementById('holiday-name');
            
            if (holidayName) {
                holidayBanner.classList.remove('hidden');
                let displayText = ` ${formatDateDisplay(selectedDate)} æ˜¯ ${holidayName}`;
                if (holidayName.includes('è–èª•')) displayText = 'ğŸ„ ' + displayText;
                else if (holidayName.includes('å¹´') || holidayName.includes('æ˜¥ç¯€')) displayText = 'ğŸ§§ ' + displayText;
                else if (holidayName.includes('ç«¯åˆ')) displayText = 'ğŸ›¶ ' + displayText;
                else if (holidayName.includes('ä¸­ç§‹')) displayText = 'ğŸ¥® ' + displayText;
                else if (holidayName.includes('åœ‹æ…¶') || holidayName.includes('å…‰å¾©')) displayText = 'ğŸ‡¹ğŸ‡¼ ' + displayText;
                else if (holidayName.includes('æ¯') || holidayName.includes('çˆ¶')) displayText = 'â¤ï¸ ' + displayText;
                else if (holidayName.includes('è¡Œæ†²')) displayText = 'ğŸ“œ ' + displayText;
                holidayNameSpan.textContent = displayText;
            } else {
                holidayBanner.classList.add('hidden');
            }

            const currentTasks = window.tasks.filter(t => t.date === selectedDate);
            listEl.innerHTML = '';
            
            if (currentTasks.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
            } else {
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
                currentTasks.forEach(task => {
                    const li = document.createElement('div');
                    li.className = `bg-white p-3 rounded-lg md:rounded-xl shadow-sm border border-gray-100 flex items-center gap-2 md:gap-3 transition-all hover:shadow-md ${task.completed ? 'bg-gray-50' : ''}`;
                    li.innerHTML = `
                        <input type="checkbox" class="task-checkbox w-5 h-5 md:w-6 md:h-6 text-indigo-600 rounded-md md:rounded-lg border-gray-300 focus:ring-indigo-500 cursor-pointer accent-indigo-600 shrink-0" ${task.completed ? 'checked' : ''} onchange="toggleTask(${task.id})">
                        <div class="flex-1 min-w-0 transition-opacity ${task.completed ? 'opacity-50' : ''}">
                            <div class="text-gray-800 font-medium truncate text-sm md:text-base">${escapeHtml(task.text)}</div>
                            ${task.reward > 0 ? `<div class="text-xs text-yellow-600 font-bold mt-0.5"><i class="fas fa-coins"></i> çå‹µ $${task.reward}</div>` : ''}
                        </div>
                        
                        <button onclick="openEditModal(${task.id})" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-indigo-500 transition rounded-full hover:bg-indigo-50 shrink-0">
                            <i class="fas fa-pen"></i>
                        </button>
                        
                        <button onclick="deleteTask(${task.id})" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 transition rounded-full hover:bg-red-50 shrink-0"><i class="fas fa-trash-alt"></i></button>
                    `;
                    listEl.appendChild(li);
                });
            }
        }

        function addTask() {
            const input = document.getElementById('task-input');
            const rewardInput = document.getElementById('reward-input');
            const text = input.value.trim();
            const reward = parseInt(rewardInput.value) || 0;
            if (text) {
                window.tasks.push({ id: Date.now(), text: text, reward: reward, completed: false, date: selectedDate });
                input.value = ''; rewardInput.value = ''; saveData(); input.focus();
            }
        }

        function toggleTask(id) {
            const task = window.tasks.find(t => t.id === id);
            if (task) { task.completed = !task.completed; saveData(); }
        }

        function deleteTask(id) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) { window.tasks = window.tasks.filter(t => t.id !== id); saveData(); }
        }

        // Calendar View
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthYearTitle = document.getElementById('calendar-month-year');
            grid.innerHTML = '';
            
            const dt = new Date(calendarYear, calendarMonth, 1);
            monthYearTitle.textContent = `${calendarYear}å¹´ ${calendarMonth + 1}æœˆ`;
            
            const firstDayIndex = dt.getDay(); 
            const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
            const todayStr = getTaipeiDateString();

            for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement('div'));

            for (let d = 1; d <= daysInMonth; d++) {
                const dayStr = `${calendarYear}-${String(calendarMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const cell = document.createElement('div');
                const hasTask = window.tasks.some(t => t.date === dayStr);
                const isHoliday = getHolidayName(dayStr) !== null;
                
                let classes = 'calendar-day';
                if (dayStr === todayStr) classes += ' today';
                if (dayStr === selectedDate) classes += ' active';
                if (hasTask) classes += ' has-task';
                if (isHoliday) classes += ' is-holiday'; 

                cell.className = classes;
                cell.textContent = d;
                cell.onclick = () => selectDateInCalendar(dayStr);
                grid.appendChild(cell);
            }
            updateCalendarPreview();
        }

        function changeMonth(offset) {
            calendarMonth += offset;
            if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; } 
            else if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
            renderCalendar();
        }

        function selectDateInCalendar(dateStr) { selectedDate = dateStr; renderCalendar(); }

        function updateCalendarPreview() {
            const previewList = document.getElementById('calendar-preview-list');
            const previewLabel = document.getElementById('preview-date-label');
            const editBtn = document.getElementById('btn-edit-date');
            const holidayInfo = document.getElementById('calendar-holiday-info');
            const holidayNameSpan = document.getElementById('calendar-holiday-name');

            const [y, m, d] = selectedDate.split('-');
            previewLabel.textContent = `${m}æœˆ${d}æ—¥ çš„è¨ˆç•«`;
            
            const holidayName = getHolidayName(selectedDate);
            if (holidayName) { holidayInfo.classList.remove('hidden'); holidayNameSpan.textContent = holidayName; } else { holidayInfo.classList.add('hidden'); }

            const dayTasks = window.tasks.filter(t => t.date === selectedDate);
            previewList.innerHTML = '';
            if (dayTasks.length === 0) {
                previewList.innerHTML = '<li class="text-center py-2 text-gray-400">é€™å¤©é‚„æ²’æœ‰å®‰æ’è¨ˆç•«</li>';
            } else {
                dayTasks.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center gap-2 truncate';
                    li.innerHTML = `<i class="fas fa-circle text-[6px] ${t.completed ? 'text-gray-300' : 'text-indigo-400'}"></i><span class="${t.completed ? 'line-through text-gray-400' : ''}">${escapeHtml(t.text)}</span>${t.reward > 0 ? `<span class="text-xs text-yellow-600 ml-auto">$${t.reward}</span>` : ''}`;
                    previewList.appendChild(li);
                });
            }
            editBtn.classList.remove('hidden');
        }

        function editSelectedDate() { switchTab('daily'); }

        // Shop View
        function renderShop() {
            const shopListEl = document.getElementById('shop-list');
            const historyEl = document.getElementById('redemption-history');
            const balance = calculateBalance();

            const completedCount = window.tasks.filter(t => t.completed).length;
            const headerCountDisplay = document.getElementById('completed-count-display');
            if (headerCountDisplay) {
                headerCountDisplay.textContent = completedCount;
            }

            shopListEl.innerHTML = '';
            if(window.shopItems.length === 0) {
                shopListEl.innerHTML = '<div class="text-center text-gray-400 py-4">é‚„æ²’æœ‰çå‹µå•†å“ï¼Œæ–°å¢ä¸€å€‹å§ï¼</div>';
            } else {
                window.shopItems.forEach(item => {
                    const canAfford = balance >= item.cost;
                    const card = document.createElement('div');
                    card.className = `bg-white p-3 md:p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 ${!canAfford ? 'opacity-70' : ''}`;
                    card.innerHTML = `
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-500 shrink-0"><i class="fas fa-gift"></i></div>
                            <div class="min-w-0 flex-1">
                                <div class="font-medium text-gray-800 truncate text-sm md:text-base">${escapeHtml(item.text)}</div>
                                <div class="text-xs font-bold ${canAfford ? 'text-yellow-600' : 'text-red-400'}"><i class="fas fa-coins"></i> $${item.cost} ${!canAfford ? `<span class="font-normal text-red-300 ml-1">(å·® $${item.cost - balance})</span>` : ''}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 w-full sm:w-auto justify-end border-t pt-2 sm:border-t-0 sm:pt-0 border-gray-100">
                             <button onclick="redeemItem(${item.id})" ${!canAfford ? 'disabled' : ''} class="flex-1 sm:flex-none px-4 py-1.5 rounded-lg text-sm font-bold text-white transition shadow-sm active:scale-95 ${canAfford ? 'bg-gradient-to-r from-yellow-400 to-orange-500 hover:shadow-md cursor-pointer' : 'bg-gray-300 cursor-not-allowed'}">å…Œæ›</button>
                            <button onclick="deleteShopItem(${item.id})" class="text-gray-300 hover:text-red-400 px-2"><i class="fas fa-trash-alt text-sm"></i></button>
                        </div>
                    `;
                    shopListEl.appendChild(card);
                });
            }

            historyEl.innerHTML = '';
            const recentRedemptions = [...window.redemptions].reverse().slice(0, 5);
            if(recentRedemptions.length === 0) {
                historyEl.innerHTML = '<li class="text-center py-2 text-gray-300 text-xs">å°šç„¡å…Œæ›ç´€éŒ„</li>';
            } else {
                recentRedemptions.forEach(r => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center border-b border-gray-100 pb-1 last:border-0';
                    li.innerHTML = `<span class="truncate pr-2">${escapeHtml(r.text)}</span><span class="text-xs text-gray-400 whitespace-nowrap">-${r.cost} <i class="fas fa-coins text-[10px]"></i></span>`;
                    historyEl.appendChild(li);
                });
            }
        }

        // æŠŠé€™äº›å‡½å¼ç§»åˆ° renderShop å¤–é¢ï¼Œè®Šæˆå…¨åŸŸå‡½å¼ï¼Œé€™æ¨£ HTML onclick æ‰èƒ½å‘¼å«åˆ°
        function addShopItem() {
            const input = document.getElementById('shop-item-input');
            const costInput = document.getElementById('shop-cost-input');
            const text = input.value.trim();
            const cost = parseInt(costInput.value);
            if (text && cost > 0) {
                window.shopItems.push({ id: Date.now(), text: text, cost: cost });
                input.value = ''; costInput.value = ''; saveData();
            } else { alert('è«‹è¼¸å…¥åç¨±èˆ‡æ­£ç¢ºçš„é‡‘é¡'); }
        }

        function deleteShopItem(id) { if(confirm('ç§»é™¤é€™å€‹çå‹µé¸é …ï¼Ÿ')) { window.shopItems = window.shopItems.filter(item => item.id !== id); saveData(); } }

        function redeemItem(id) {
            const item = window.shopItems.find(i => i.id === id);
            const balance = calculateBalance();
            if (item && balance >= item.cost) {
                if(confirm(`ç¢ºå®šè¦èŠ±è²» $${item.cost} å…Œæ›ã€Œ${item.text}ã€å—ï¼Ÿ`)) {
                    window.redemptions.push({ id: Date.now(), itemId: item.id, text: item.text, cost: item.cost, date: new Date().toISOString() });
                    saveData();
                    alert(`å…Œæ›æˆåŠŸï¼äº«å—ä½ çš„ ${item.text} å§ï¼`);
                }
            } else { alert('é‡‘å¹£ä¸è¶³ï¼'); }
        }

        function switchTab(tab) {
            currentView = tab;
            const views = { 'daily': document.getElementById('view-list'), 'monthly': document.getElementById('view-calendar'), 'shop': document.getElementById('view-shop') };
            const tabs = { 'daily': document.getElementById('tab-daily'), 'monthly': document.getElementById('tab-monthly'), 'shop': document.getElementById('tab-shop') };

            Object.values(views).forEach(el => { el.classList.add('translate-x-full'); el.classList.remove('z-30'); });
            Object.values(tabs).forEach(el => el.classList.remove('active'));

            views[tab].classList.remove('translate-x-full');
            tabs[tab].classList.add('active');

            if (tab === 'daily') {
                renderTaskList();
            } else if (tab === 'monthly') {
                const [y, m] = selectedDate.split('-');
                calendarYear = parseInt(y); calendarMonth = parseInt(m) - 1;
                renderCalendar();
            } else if (tab === 'shop') { renderShop(); }
            saveData(); 
        }

        // ç¨ç«‹å‡ºã€Œé»æ“Šæ¯æ—¥è¨ˆç•«ã€çš„è¡Œç‚º
        function clickDailyTab() {
            selectedDate = getTaipeiDateString(); 
            switchTab('daily');
        }

        function backToToday() { selectedDate = getTaipeiDateString(); renderTaskList(); }

        // --- æ–°å¢ï¼šç·¨è¼¯åŠŸèƒ½ç›¸é—œå‡½å¼ ---
        
        function openEditModal(id) {
            const task = window.tasks.find(t => t.id === id);
            if (!task) return;

            // æŠŠè³‡æ–™å¡«å…¥è¼¸å…¥æ¡†
            document.getElementById('edit-task-id').value = task.id;
            document.getElementById('edit-task-text').value = task.text;
            document.getElementById('edit-task-reward').value = task.reward;

            // é¡¯ç¤ºè¦–çª—
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function saveEditTask() {
            const id = parseFloat(document.getElementById('edit-task-id').value);
            const newText = document.getElementById('edit-task-text').value.trim();
            const newReward = parseInt(document.getElementById('edit-task-reward').value) || 0;

            if (!newText) {
                alert('è¨ˆç•«å…§å®¹ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }

            // æ›´æ–°é™£åˆ—ä¸­çš„è³‡æ–™
            const taskIndex = window.tasks.findIndex(t => t.id === id);
            if (taskIndex !== -1) {
                window.tasks[taskIndex].text = newText;
                window.tasks[taskIndex].reward = newReward;
                
                saveData(); // å„²å­˜ä¸¦åŒæ­¥é›²ç«¯
                closeEditModal();
                alert('ä¿®æ”¹æˆåŠŸï¼');
            } else {
                alert('æ‰¾ä¸åˆ°è©²è¨ˆç•«ï¼Œå¯èƒ½å·²è¢«åˆªé™¤ã€‚');
                closeEditModal();
            }
        }

        updateHeader();
        renderTaskList();
        setInterval(updateHeader, 60000);

// --- æ–°å¢ï¼šå³æ™‚æ™‚é˜åŠŸèƒ½ ---
        function updateRealTimeClock() {
            const now = new Date();
            // å–å¾—å°åŒ—æ™‚é–“
            const timeStr = now.toLocaleTimeString('zh-TW', {
                timeZone: 'Asia/Taipei',
                hour12: false, // ä½¿ç”¨ 24 å°æ™‚åˆ¶ (è‹¥è¦ 12 å°æ™‚åˆ¶æ”¹æˆ true)
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const clockEl = document.getElementById('header-clock');
            if (clockEl) {
                clockEl.innerHTML = timeStr;
            }
        }

        // å•Ÿå‹•æ™‚é˜ï¼Œæ¯ç§’æ›´æ–° (1000 æ¯«ç§’)
        setInterval(updateRealTimeClock, 1000);
        updateRealTimeClock(); // åˆå§‹åŒ–æ™‚é¦¬ä¸ŠåŸ·è¡Œä¸€æ¬¡
    </script>
</body>
</html>
